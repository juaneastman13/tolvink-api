// =====================================================================
// TOLVINK — Prisma Schema v4 FINAL (Production)
// PostgreSQL · Multi-tenant · Freight = 1 viaje
// ALL models included: Fields, Trucks, PlantAccess, Chat, Tracking, User v2
// =====================================================================

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ======================== ENUMS ======================================

enum CompanyType {
  producer
  plant
  transporter
}

enum UserRole {
  admin
  operator
  platform_admin
}

enum FreightStatus {
  draft
  pending_assignment
  assigned
  accepted
  in_progress
  loaded
  finished
  canceled
}

enum AssignmentStatus {
  active
  accepted
  rejected
  canceled
}

enum GrainType {
  Soja
  Maiz
  Trigo
  Girasol
  Sorgo
  Cebada
}

enum NotificationType {
  freight_created
  freight_assigned
  freight_accepted
  freight_rejected
  freight_started
  freight_loaded
  freight_confirmed
  freight_finished
  freight_canceled
  message_received
  conversation_started
}

enum DocumentStep {
  request
  assignment
  load_confirmation
  delivery_confirmation
  cancellation
}

// ======================== COMPANIES ==================================

model Company {
  id        String      @id @default(uuid())
  name      String      @db.VarChar(255)
  type      CompanyType
  address   String?
  phone     String?     @db.VarChar(50)
  email     String?     @db.VarChar(255)
  active    Boolean     @default(true)
  hasInternalFleet Boolean @default(false) @map("has_internal_fleet")
  createdAt DateTime    @default(now()) @map("created_at")
  updatedAt DateTime    @updatedAt @map("updated_at")

  users              User[]
  fields             Field[]
  lots               Lot[]
  plants             Plant[]
  trucks             Truck[]
  freightsAsOrigin   Freight[]           @relation("FreightOriginCompany")
  freightsAsDest     Freight[]           @relation("FreightDestCompany")
  assignments        FreightAssignment[] @relation("AssignmentTransporter")
  notifications      Notification[]
  plantAccessGiven     PlantProducerAccess[] @relation("PlantAccessGiven")
  producerAccessReceived PlantProducerAccess[] @relation("ProducerAccessReceived")

  @@map("companies")
}

// ======================== USERS ======================================

model User {
  id           String   @id @default(uuid())
  email        String   @unique @db.VarChar(255)
  passwordHash String   @map("password_hash") @db.VarChar(255)
  name         String   @db.VarChar(255)
  role         UserRole @default(operator)
  companyId    String?  @map("company_id")
  phone        String?  @unique @db.VarChar(50)
  userTypes    Json     @default("[]") @map("user_types")
  isSuperAdmin Boolean  @default(false) @map("is_super_admin")
  active       Boolean  @default(true)
  lastLogin    DateTime? @map("last_login")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  company            Company?            @relation(fields: [companyId], references: [id], onDelete: SetNull)
  freightsRequested  Freight[]           @relation("FreightRequestedBy")
  assignmentsMade    FreightAssignment[] @relation("AssignmentAssignedBy")
  assignmentsAsDriver FreightAssignment[] @relation("AssignmentDriver")
  trucksAssigned     Truck[]             @relation("TruckAssignedUser")
  messagesSent       Message[]
  auditLogs          AuditLog[]
  notifications      Notification[]

  @@index([companyId])
  @@index([email])
  @@index([phone])
  @@map("users")
}

// ======================== FIELDS =====================================

model Field {
  id        String   @id @default(uuid())
  name      String   @db.VarChar(255)
  companyId String   @map("company_id")
  address   String?
  lat       Decimal? @db.Decimal(10, 6)
  lng       Decimal? @db.Decimal(10, 6)
  active    Boolean  @default(true)
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  company  Company   @relation(fields: [companyId], references: [id], onDelete: Cascade)
  lots     Lot[]
  freights Freight[]

  @@index([companyId])
  @@map("fields")
}

// ======================== LOTS =======================================

model Lot {
  id        String   @id @default(uuid())
  name      String   @db.VarChar(255)
  companyId String   @map("company_id")
  fieldId   String?  @map("field_id")
  hectares  Decimal? @db.Decimal(10, 2)
  lat       Decimal? @db.Decimal(10, 6)
  lng       Decimal? @db.Decimal(10, 6)
  active    Boolean  @default(true)
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  company  Company   @relation(fields: [companyId], references: [id], onDelete: Cascade)
  field    Field?    @relation(fields: [fieldId], references: [id], onDelete: SetNull)
  freights Freight[] @relation("FreightOriginLot")

  @@index([companyId])
  @@index([fieldId])
  @@map("lots")
}

// ======================== PLANTS =====================================

model Plant {
  id        String  @id @default(uuid())
  name      String  @db.VarChar(255)
  companyId String  @map("company_id")
  address   String?
  lat       Decimal @db.Decimal(10, 6)
  lng       Decimal @db.Decimal(10, 6)
  active    Boolean @default(true)
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  company  Company   @relation(fields: [companyId], references: [id], onDelete: Cascade)
  freights Freight[] @relation("FreightDestPlant")

  @@index([companyId])
  @@map("plants")
}

// ======================== TRUCKS =====================================

model Truck {
  id             String   @id @default(uuid())
  plate          String   @unique @db.VarChar(20)
  model          String?  @db.VarChar(100)
  companyId      String   @map("company_id")
  assignedUserId String?  @map("assigned_user_id")
  active         Boolean  @default(true)
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")

  company      Company              @relation(fields: [companyId], references: [id], onDelete: Cascade)
  assignedUser User?                @relation("TruckAssignedUser", fields: [assignedUserId], references: [id], onDelete: SetNull)
  assignments  FreightAssignment[]

  @@index([companyId])
  @@index([plate])
  @@map("trucks")
}

// ======================== PLANT-PRODUCER ACCESS ======================

model PlantProducerAccess {
  id                String   @id @default(uuid())
  plantCompanyId    String   @map("plant_company_id")
  producerCompanyId String   @map("producer_company_id")
  active            Boolean  @default(true)
  createdAt         DateTime @default(now()) @map("created_at")
  updatedAt         DateTime @updatedAt @map("updated_at")

  plantCompany    Company @relation("PlantAccessGiven", fields: [plantCompanyId], references: [id], onDelete: Cascade)
  producerCompany Company @relation("ProducerAccessReceived", fields: [producerCompanyId], references: [id], onDelete: Cascade)

  @@unique([plantCompanyId, producerCompanyId])
  @@index([plantCompanyId])
  @@index([producerCompanyId])
  @@map("plant_producer_access")
}

// ======================== FREIGHTS ===================================

model Freight {
  id     String        @id @default(uuid())
  code   String        @unique @db.VarChar(20)
  status FreightStatus @default(draft)

  // Origin
  originCompanyId String  @map("origin_company_id")
  originLotId     String? @map("origin_lot_id")
  fieldId         String? @map("field_id")
  originName      String  @db.VarChar(255)
  originLat       Decimal? @db.Decimal(10, 6)
  originLng       Decimal? @db.Decimal(10, 6)

  // Destination
  destCompanyId String  @map("dest_company_id")
  destPlantId   String? @map("dest_plant_id")
  destName      String  @db.VarChar(255)
  destLat       Decimal? @db.Decimal(10, 6)
  destLng       Decimal? @db.Decimal(10, 6)

  // Schedule
  loadDate    DateTime  @map("load_date") @db.Date
  loadTime    String    @map("load_time") @db.VarChar(5)
  scheduledAt DateTime? @map("scheduled_at")

  // Audit
  requestedById String   @map("requested_by_id")
  notes         String?
  cancelReason  String?  @map("cancel_reason") @db.VarChar(255)

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")
  startedAt DateTime? @map("started_at")
  finishedAt DateTime? @map("finished_at")
  loadedAt  DateTime? @map("loaded_at")

  // Cross-confirmations
  transporterLoadedConfirmedAt   DateTime? @map("transporter_loaded_confirmed_at")
  producerLoadedConfirmedAt      DateTime? @map("producer_loaded_confirmed_at")
  transporterFinishedConfirmedAt DateTime? @map("transporter_finished_confirmed_at")
  plantFinishedConfirmedAt       DateTime? @map("plant_finished_confirmed_at")

  // Relations
  originCompany Company  @relation("FreightOriginCompany", fields: [originCompanyId], references: [id])
  destCompany   Company  @relation("FreightDestCompany", fields: [destCompanyId], references: [id])
  originLot     Lot?     @relation("FreightOriginLot", fields: [originLotId], references: [id], onDelete: SetNull)
  destPlant     Plant?   @relation("FreightDestPlant", fields: [destPlantId], references: [id], onDelete: SetNull)
  field         Field?   @relation(fields: [fieldId], references: [id], onDelete: SetNull)
  requestedBy   User     @relation("FreightRequestedBy", fields: [requestedById], references: [id])

  items           FreightItem[]
  assignments     FreightAssignment[]
  documents       FreightDocument[]
  conversation    Conversation?       @relation("FreightConversation")
  auditLogs       AuditLog[]
  trackingPoints  FreightTracking[]

  @@index([status])
  @@index([originCompanyId])
  @@index([destCompanyId])
  @@index([loadDate])
  @@index([code])
  @@index([fieldId])
  @@map("freights")
}

// ======================== FREIGHT ITEMS ==============================

model FreightItem {
  id        String    @id @default(uuid())
  freightId String    @map("freight_id")
  grain     GrainType
  tons      Decimal   @db.Decimal(10, 2)
  notes     String?
  createdAt DateTime  @default(now()) @map("created_at")

  freight Freight @relation(fields: [freightId], references: [id], onDelete: Cascade)

  @@index([freightId])
  @@map("freight_items")
}

// ======================== FREIGHT ASSIGNMENTS =========================

model FreightAssignment {
  id                  String           @id @default(uuid())
  freightId           String           @map("freight_id")
  transportCompanyId  String           @map("transport_company_id")
  status              AssignmentStatus @default(active)

  driverId    String?  @map("driver_id")
  driverName  String?  @map("driver_name") @db.VarChar(255)
  plate       String?  @db.VarChar(20)
  truckId     String?  @map("truck_id")

  assignedById String  @map("assigned_by_id")
  reason String? @db.VarChar(255)

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  freight          Freight @relation(fields: [freightId], references: [id], onDelete: Cascade)
  transportCompany Company @relation("AssignmentTransporter", fields: [transportCompanyId], references: [id])
  assignedBy       User    @relation("AssignmentAssignedBy", fields: [assignedById], references: [id])
  driver           User?   @relation("AssignmentDriver", fields: [driverId], references: [id])
  truck            Truck?  @relation(fields: [truckId], references: [id], onDelete: SetNull)

  @@index([freightId])
  @@index([transportCompanyId])
  @@index([status])
  @@index([truckId])
  @@map("freight_assignments")
}

// ======================== FREIGHT DOCUMENTS ===========================

model FreightDocument {
  id           String        @id @default(uuid())
  freightId    String        @map("freight_id")
  name         String        @db.VarChar(255)
  url          String        @db.VarChar(500)
  type         String        @db.VarChar(50)
  step         DocumentStep?
  uploadedById String        @map("uploaded_by_id")
  createdAt    DateTime      @default(now()) @map("created_at")

  freight Freight @relation(fields: [freightId], references: [id], onDelete: Cascade)

  @@index([freightId])
  @@index([freightId, step])
  @@map("freight_documents")
}

// ======================== FREIGHT TRACKING ============================

model FreightTracking {
  id        String   @id @default(uuid())
  freightId String   @map("freight_id")
  userId    String?  @map("user_id")
  lat       Decimal  @db.Decimal(10, 6)
  lng       Decimal  @db.Decimal(10, 6)
  speed     Decimal? @db.Decimal(6, 2)
  heading   Decimal? @db.Decimal(5, 2)
  createdAt DateTime @default(now()) @map("created_at")

  freight Freight @relation(fields: [freightId], references: [id], onDelete: Cascade)

  @@index([freightId])
  @@index([createdAt])
  @@map("freight_tracking")
}
// ======================== CONVERSATION PARTICIPANTS ===================

model ConversationParticipant {
  id             String   @id @default(uuid())
  conversationId String   @map("conversation_id")
  companyId      String   @map("company_id")
  joinedAt       DateTime @default(now()) @map("joined_at")

  conversation Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  @@unique([conversationId, companyId])
  @@index([companyId])
  @@map("conversation_participants")
}

// ======================== MESSAGES ====================================

model Message {
  id             String   @id @default(uuid())
  conversationId String   @map("conversation_id")
  senderId       String   @map("sender_id")
  text           String   @db.VarChar(2000)
  createdAt      DateTime @default(now()) @map("created_at")

  conversation Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  sender       User         @relation(fields: [senderId], references: [id])

  @@index([conversationId])
  @@index([createdAt])
  @@map("messages")
}

// ======================== AUDIT LOGS =================================

model AuditLog {
  id         String   @id @default(uuid())
  entityType String   @map("entity_type") @db.VarChar(30)
  entityId   String   @map("entity_id")
  action     String   @db.VarChar(50)
  fromValue  String?  @map("from_value") @db.VarChar(50)
  toValue    String?  @map("to_value") @db.VarChar(50)
  userId     String   @map("user_id")
  reason     String?  @db.VarChar(255)
  metadata   Json?
  createdAt  DateTime @default(now()) @map("created_at")

  user    User     @relation(fields: [userId], references: [id])
  freight Freight? @relation(fields: [entityId], references: [id], onDelete: Cascade)

  @@index([entityType, entityId])
  @@index([userId])
  @@index([createdAt])
  @@map("audit_logs")
}

// ======================== NOTIFICATIONS ===============================

model Notification {
  id        String           @id @default(uuid())
  userId    String           @map("user_id")
  companyId String?          @map("company_id")
  type      NotificationType
  title     String           @db.VarChar(255)
  body      String?          @db.VarChar(500)
  entityId  String?          @map("entity_id")
  read      Boolean          @default(false)
  createdAt DateTime         @default(now()) @map("created_at")

  user    User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  company Company? @relation(fields: [companyId], references: [id], onDelete: SetNull)

  @@index([userId, read])
  @@index([createdAt])
  @@map("notifications")
}
